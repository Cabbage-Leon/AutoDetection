{% extends "base.html" %}

{% block title %}任务管理 - 智能秒杀系统{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">任务管理</h5>
                    <div>
                        <button class="btn btn-success btn-sm me-2" onclick="startScheduler()" id="startSchedulerBtn">
                            <i class="fas fa-play"></i> 启动调度器
                        </button>
                        <button class="btn btn-danger btn-sm me-2" onclick="stopScheduler()" id="stopSchedulerBtn">
                            <i class="fas fa-stop"></i> 停止调度器
                        </button>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                            <i class="fas fa-plus"></i> 添加任务
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 调度器状态显示 -->
                    <div class="alert alert-info mb-3" id="schedulerStatus">
                        <i class="fas fa-info-circle"></i> 调度器状态: <span id="schedulerStatusText">检查中...</span>
                    </div>
                    
                    <div id="taskList" class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>任务名称</th>
                                    <th>状态</th>
                                    <th>执行时间</th>
                                    <th>进度</th>
                                    <th>成功率</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="taskTableBody">
                                <!-- 任务列表将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 空状态提示 -->
                    <div id="emptyState" class="text-center py-5" style="display: none;">
                        <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">暂无任务</h5>
                        <p class="text-muted">点击"添加任务"按钮创建您的第一个秒杀任务</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加任务模态框 -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>添加秒杀任务
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 步骤指示器 -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar" id="stepProgress" role="progressbar" style="width: 50%"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="badge bg-primary" id="step1Badge">步骤 1: 基础设置</span>
                            <span class="badge bg-secondary" id="step2Badge">步骤 2: 高级设置</span>
                        </div>
                    </div>
                </div>

                <form id="addTaskForm">
                    <!-- 步骤一：基础设置 -->
                    <div id="step1" class="step-content">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-cog me-2"></i>基础设置
                                    <span class="badge bg-light text-primary ms-2">必填</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="taskName" class="form-label">
                                                任务名称 <span class="text-danger">*</span>
                                                <i class="fas fa-question-circle text-muted ms-1" 
                                                   data-bs-toggle="tooltip" title="给任务起一个容易识别的名字"></i>
                                            </label>
                                            <input type="text" class="form-control" id="taskName" required 
                                                   placeholder="例如：iPhone 15 秒杀任务">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="taskUrl" class="form-label">
                                                目标URL <span class="text-danger">*</span>
                                                <i class="fas fa-question-circle text-muted ms-1" 
                                                   data-bs-toggle="tooltip" title="要秒杀的商品页面地址"></i>
                                            </label>
                                            <input type="url" class="form-control" id="taskUrl" required 
                                                   placeholder="https://example.com/product/123">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="executionTime" class="form-label">
                                                执行时间 <span class="text-danger">*</span>
                                                <i class="fas fa-question-circle text-muted ms-1" 
                                                   data-bs-toggle="tooltip" title="设置秒杀开始的时间"></i>
                                            </label>
                                            <input type="datetime-local" class="form-control" id="executionTime" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="timezone" class="form-label">
                                                时区
                                                <i class="fas fa-question-circle text-muted ms-1" 
                                                   data-bs-toggle="tooltip" title="选择执行时间的时区"></i>
                                            </label>
                                            <select class="form-control" id="timezone">
                                                <option value="Asia/Shanghai">北京时间 (UTC+8)</option>
                                                <option value="local">本地时间</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="targetSelector" class="form-label">
                                                目标元素选择器 <span class="text-danger">*</span>
                                                <i class="fas fa-question-circle text-muted ms-1" 
                                                   data-bs-toggle="tooltip" title="要点击的按钮或链接的选择器"></i>
                                            </label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="targetSelector" required 
                                                       placeholder="例如：#buy-button 或 .submit-btn">
                                                <button type="button" class="btn btn-outline-secondary" onclick="openElementSelector()">
                                                    <i class="fas fa-mouse-pointer"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="targetType" class="form-label">
                                                选择器类型
                                                <i class="fas fa-question-circle text-muted ms-1" 
                                                   data-bs-toggle="tooltip" title="选择器使用的定位方式"></i>
                                            </label>
                                            <select class="form-control" id="targetType">
                                                <option value="css">CSS选择器 (推荐)</option>
                                                <option value="xpath">XPath</option>
                                                <option value="text">文本内容</option>
                                                <option value="tag">标签名</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="clickMode" class="form-label">
                                                点击模式 <span class="text-danger">*</span>
                                                <span class="badge bg-success ms-2">推荐</span>
                                                <i class="fas fa-question-circle text-muted ms-1" 
                                                   data-bs-toggle="tooltip" title="单次点击适合大多数场景，连续点击适合高并发秒杀"></i>
                                            </label>
                                            <select class="form-control" id="clickMode">
                                                <option value="single">单次点击 (推荐)</option>
                                                <option value="continuous">连续点击 (高并发)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <button type="button" class="btn btn-outline-info btn-sm mt-4" onclick="loadRecommendedConfig()">
                                                <i class="fas fa-magic"></i> 加载推荐配置
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 步骤二：高级设置 -->
                    <div id="step2" class="step-content" style="display: none;">
                        <div class="card border-secondary">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-sliders-h me-2"></i>高级设置
                                    <span class="badge bg-light text-secondary ms-2">可选</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- 连续点击设置 -->
                                <div id="continuousSettings" class="mb-4" style="display: none;">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-mouse me-2"></i>连续点击设置
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="clickCount" class="form-label">
                                                    连续点击次数
                                                    <i class="fas fa-question-circle text-muted ms-1" 
                                                       data-bs-toggle="tooltip" title="设置连续点击的次数，建议1-10次"></i>
                                                </label>
                                                <input type="number" class="form-control" id="clickCount" value="1" min="1" max="100">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="clickInterval" class="form-label">
                                                    点击间隔（秒）
                                                    <i class="fas fa-question-circle text-muted ms-1" 
                                                       data-bs-toggle="tooltip" title="连续点击之间的间隔时间"></i>
                                                </label>
                                                <input type="number" class="form-control" id="clickInterval" value="0.1" min="0.01" max="10" step="0.01">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 倒计时设置 -->
                                <div class="mb-4">
                                    <h6 class="text-info mb-3">
                                        <i class="fas fa-clock me-2"></i>倒计时设置
                                        <small class="text-muted">(仅当页面有倒计时显示时填写)</small>
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="countdownSelector" class="form-label">
                                                    倒计时元素选择器
                                                    <i class="fas fa-question-circle text-muted ms-1" 
                                                       data-bs-toggle="tooltip" title="页面倒计时显示元素的选择器"></i>
                                                </label>
                                                <input type="text" class="form-control" id="countdownSelector" 
                                                       placeholder="例如：.countdown-timer">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="countdownType" class="form-label">
                                                    倒计时选择器类型
                                                </label>
                                                <select class="form-control" id="countdownType">
                                                    <option value="css">CSS选择器</option>
                                                    <option value="xpath">XPath</option>
                                                    <option value="text">文本内容</option>
                                                    <option value="tag">标签名</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="countdownThreshold" class="form-label">
                                                    倒计时阈值（秒）
                                                    <i class="fas fa-question-circle text-muted ms-1" 
                                                       data-bs-toggle="tooltip" title="倒计时小于等于此值时开始执行"></i>
                                                </label>
                                                <input type="number" class="form-control" id="countdownThreshold" value="0" min="0">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 执行控制设置 -->
                                <div class="mb-4">
                                    <h6 class="text-warning mb-3">
                                        <i class="fas fa-cogs me-2"></i>执行控制设置
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="frequency" class="form-label">
                                                    执行频率（秒）
                                                    <i class="fas fa-question-circle text-muted ms-1" 
                                                       data-bs-toggle="tooltip" title="任务重试的间隔时间"></i>
                                                </label>
                                                <input type="number" class="form-control" id="frequency" value="1" min="1">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="maxAttempts" class="form-label">
                                                    最大尝试次数
                                                    <i class="fas fa-question-circle text-muted ms-1" 
                                                       data-bs-toggle="tooltip" title="任务最大重试次数，防止无限循环"></i>
                                                </label>
                                                <input type="number" class="form-control" id="maxAttempts" value="10" min="1">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 任务备注 -->
                                <div class="mb-3">
                                    <label for="taskRemark" class="form-label">
                                        任务备注
                                        <i class="fas fa-question-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" title="添加任务说明或备注信息"></i>
                                    </label>
                                    <textarea class="form-control" id="taskRemark" rows="3" 
                                              placeholder="可选：添加任务说明、注意事项等"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button type="button" class="btn btn-outline-primary" id="prevStepBtn" onclick="prevStep()" style="display: none;">
                    <i class="fas fa-arrow-left"></i> 上一步
                </button>
                <button type="button" class="btn btn-primary" id="nextStepBtn" onclick="nextStep()">
                    <i class="fas fa-arrow-right"></i> 下一步
                </button>
                <button type="button" class="btn btn-success" id="submitBtn" onclick="createTask()" style="display: none;">
                    <i class="fas fa-check"></i> 创建任务
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 任务详情模态框 -->
<div class="modal fade" id="taskDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">任务详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="taskDetailContent">
                    <!-- 任务详情将通过JavaScript动态加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast通知组件 -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-info-circle me-2" id="toastIcon"></i>
            <strong class="me-auto" id="toastTitle">通知</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
        </div>
    </div>
</div>

<script>
// 全局变量
let tasks = [];
let currentStep = 1;
let updateInterval;
let schedulerStatusInterval;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    initializeTooltips();
});

function initializePage() {
    // 加载任务列表
    loadTasks();
    
    // 加载调度器状态
    loadSchedulerStatus();
    
    // 设置执行时间默认值为当前时间+5分钟
    const now = new Date();
    now.setMinutes(now.getMinutes() + 5);
    document.getElementById('executionTime').value = now.toISOString().slice(0, 16);

    // 点击模式切换逻辑
    document.getElementById('clickMode').addEventListener('change', function() {
        toggleContinuousSettings();
    });
    
    // 倒计时选择器联动
    document.getElementById('countdownSelector').addEventListener('input', function() {
        toggleCountdownSettings();
    });
    
    // 设置定时器，每3秒更新一次任务状态
    updateInterval = setInterval(loadTasks, 3000);
    
    // 设置定时器，每5秒更新一次调度器状态
    schedulerStatusInterval = setInterval(loadSchedulerStatus, 5000);
}

function initializeTooltips() {
    // 初始化所有工具提示
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

// 分步表单相关函数
function nextStep() {
    if (currentStep === 1) {
        if (validateStep1()) {
            currentStep = 2;
            showStep2();
            updateStepProgress();
        }
    }
}

function prevStep() {
    if (currentStep === 2) {
        currentStep = 1;
        showStep1();
        updateStepProgress();
    }
}

function showStep1() {
    document.getElementById('step1').style.display = 'block';
    document.getElementById('step2').style.display = 'none';
    document.getElementById('prevStepBtn').style.display = 'none';
    document.getElementById('nextStepBtn').style.display = 'inline-block';
    document.getElementById('submitBtn').style.display = 'none';
}

function showStep2() {
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    document.getElementById('prevStepBtn').style.display = 'inline-block';
    document.getElementById('nextStepBtn').style.display = 'none';
    document.getElementById('submitBtn').style.display = 'inline-block';
}

function updateStepProgress() {
    const progress = currentStep === 1 ? 50 : 100;
    document.getElementById('stepProgress').style.width = progress + '%';
    
    // 更新步骤徽章
    if (currentStep === 1) {
        document.getElementById('step1Badge').className = 'badge bg-primary';
        document.getElementById('step2Badge').className = 'badge bg-secondary';
    } else {
        document.getElementById('step1Badge').className = 'badge bg-success';
        document.getElementById('step2Badge').className = 'badge bg-primary';
    }
}

function validateStep1() {
    const requiredFields = ['taskName', 'taskUrl', 'executionTime', 'targetSelector'];
    let isValid = true;
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        showToast('请填写所有必填字段', 'warning');
    }
    
    return isValid;
}

function toggleContinuousSettings() {
    const clickMode = document.getElementById('clickMode').value;
    const continuousSettings = document.getElementById('continuousSettings');
    
    if (clickMode === 'continuous') {
        continuousSettings.style.display = 'block';
    } else {
        continuousSettings.style.display = 'none';
    }
}

function toggleCountdownSettings() {
    const countdownSelector = document.getElementById('countdownSelector').value;
    const countdownType = document.getElementById('countdownType');
    const countdownThreshold = document.getElementById('countdownThreshold');
    
    if (countdownSelector.trim()) {
        countdownType.disabled = false;
        countdownThreshold.disabled = false;
    } else {
        countdownType.disabled = true;
        countdownThreshold.disabled = true;
    }
}

function loadRecommendedConfig() {
    // 加载推荐配置
    const configs = {
        'single': {
            click_mode: 'single',
            click_count: 1,
            click_interval: 0.1,
            frequency: 1,
            max_attempts: 10,
            countdown_threshold: 0
        },
        'continuous': {
            click_mode: 'continuous',
            click_count: 3,
            click_interval: 0.05,
            frequency: 0.5,
            max_attempts: 20,
            countdown_threshold: 0
        },
        'high_concurrency': {
            click_mode: 'continuous',
            click_count: 5,
            click_interval: 0.02,
            frequency: 0.2,
            max_attempts: 50,
            countdown_threshold: 0
        }
    };
    
    // 显示配置选择对话框
    const configType = prompt('选择推荐配置类型：\n1. single - 单次点击（推荐新手）\n2. continuous - 连续点击（推荐）\n3. high_concurrency - 高并发（高级用户）', 'continuous');
    
    if (configType && configs[configType]) {
        const config = configs[configType];
        
        // 应用配置
        document.getElementById('clickMode').value = config.click_mode;
        document.getElementById('clickCount').value = config.click_count;
        document.getElementById('clickInterval').value = config.click_interval;
        document.getElementById('frequency').value = config.frequency;
        document.getElementById('maxAttempts').value = config.max_attempts;
        document.getElementById('countdownThreshold').value = config.countdown_threshold;
        
        // 触发联动
        toggleContinuousSettings();
        
        showToast('推荐配置已加载', 'success');
    }
}

function resetForm() {
    // 重置表单到初始状态
    document.getElementById('addTaskForm').reset();
    currentStep = 1;
    showStep1();
    updateStepProgress();
    
    // 设置默认执行时间
    const now = new Date();
    now.setMinutes(now.getMinutes() + 5);
    document.getElementById('executionTime').value = now.toISOString().slice(0, 16);
    
    // 重置联动状态
    toggleContinuousSettings();
    toggleCountdownSettings();
    
    // 清除验证状态
    document.querySelectorAll('.is-invalid').forEach(el => {
        el.classList.remove('is-invalid');
    });
}

// 打开元素选择器
function openElementSelector() {
    // 这里可以打开元素选择器页面或弹窗
    showToast('元素选择器功能开发中', 'info');
}

// 模态框事件监听
document.addEventListener('DOMContentLoaded', function() {
    // 监听模态框显示事件
    const addTaskModal = document.getElementById('addTaskModal');
    addTaskModal.addEventListener('show.bs.modal', function() {
        resetForm();
    });
    
    // 监听模态框隐藏事件
    addTaskModal.addEventListener('hidden.bs.modal', function() {
        resetForm();
    });
});

// 调度器相关函数
function startScheduler() {
    const btn = document.getElementById('startSchedulerBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 启动中...';
    
    fetch('/seckill/api/scheduler/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('调度器启动成功', 'success');
            loadSchedulerStatus();
        } else {
            showToast('调度器启动失败: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('启动调度器失败:', error);
        showToast('启动调度器失败', 'error');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i> 启动调度器';
    });
}

function stopScheduler() {
    const btn = document.getElementById('stopSchedulerBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 停止中...';
    
    fetch('/seckill/api/scheduler/stop', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('调度器停止成功', 'success');
            loadSchedulerStatus();
        } else {
            showToast('调度器停止失败: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('停止调度器失败:', error);
        showToast('停止调度器失败', 'error');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-stop"></i> 停止调度器';
    });
}

function loadSchedulerStatus() {
    fetch('/seckill/api/scheduler/status')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const status = data.data.status;
            const statusText = document.getElementById('schedulerStatusText');
            const statusDiv = document.getElementById('schedulerStatus');
            
            if (status === 'running') {
                statusText.textContent = '运行中';
                statusDiv.className = 'alert alert-success mb-3';
                statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> 调度器状态: <span id="schedulerStatusText">运行中</span>';
            } else {
                statusText.textContent = '已停止';
                statusDiv.className = 'alert alert-warning mb-3';
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 调度器状态: <span id="schedulerStatusText">已停止</span>';
            }
        }
    })
    .catch(error => {
        console.error('获取调度器状态失败:', error);
    });
}

// 任务相关函数
function loadTasks() {
    fetch('/seckill/api/tasks')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            tasks = data.data || [];
            renderTaskTable();
        } else {
            console.error('加载任务失败:', data.message);
        }
    })
    .catch(error => {
        console.error('加载任务失败:', error);
    });
}

function renderTaskTable() {
    const tbody = document.getElementById('taskTableBody');
    const emptyState = document.getElementById('emptyState');
    
    if (!tasks || tasks.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    tbody.innerHTML = '';
    
    tasks.forEach(task => {
        if (!task) return;
        
        const row = document.createElement('tr');
        const status = task.status || 'pending';
        const isRunning = status === 'running';
        const isStopped = status === 'stopped';
        const isCompleted = (task.attempts || 0) >= (task.max_attempts || 0);
        
        row.innerHTML = `
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas fa-tasks me-2 text-primary"></i>
                    <div>
                        <div class="fw-bold">${task.name || '未知任务'}</div>
                        <small class="text-muted">ID: ${task.task_id}</small>
                    </div>
                </div>
            </td>
            <td>
                <span class="badge ${getStatusBadgeClass(status)}">
                    <i class="fas ${getStatusIcon(status)} me-1"></i>
                    ${getStatusText(status)}
                </span>
                ${isRunning ? '<br><small class="text-muted">执行中...</small>' : ''}
            </td>
            <td>
                <div>${formatDateTime(task.execution_time)}</div>
                ${task.next_execution ? `<small class="text-muted">下次: ${formatDateTime(task.next_execution)}</small>` : ''}
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="progress me-2" style="width: 60px; height: 6px;">
                        <div class="progress-bar ${getProgressBarClass(task)}" 
                             style="width: ${getProgressPercentage(task)}%"></div>
                    </div>
                    <span class="small">${task.attempts || 0}/${task.max_attempts || 0}</span>
                </div>
            </td>
            <td>
                <div class="text-center">
                    <div class="fw-bold ${getSuccessRateClass(task)}">${getSuccessRateText(task)}</div>
                    <small class="text-muted">${task.success_count || 0}/${task.attempts || 0}</small>
                </div>
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewTask('${task.task_id}')" title="查看详情">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-success" onclick="startTask('${task.task_id}')" 
                            ${isRunning || isCompleted ? 'disabled' : ''} title="启动任务">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="stopTask('${task.task_id}')" 
                            ${isStopped || isCompleted ? 'disabled' : ''} title="停止任务">
                        <i class="fas fa-stop"></i>
                    </button>
                    <button class="btn btn-outline-warning" onclick="resetTask('${task.task_id}')" 
                            ${isRunning ? 'disabled' : ''} title="重置任务">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="deleteTask('${task.task_id}')" 
                            ${isRunning ? 'disabled' : ''} title="删除任务">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function createTask() {
    if (!validateStep1()) {
        showToast('请完善必填信息', 'warning');
        return;
    }
    
    const taskData = {
        name: document.getElementById('taskName').value,
        url: document.getElementById('taskUrl').value,
        target_selector: document.getElementById('targetSelector').value,
        target_type: document.getElementById('targetType').value,
        execution_time: document.getElementById('executionTime').value,
        timezone: document.getElementById('timezone').value,
        click_mode: document.getElementById('clickMode').value,
        click_count: parseInt(document.getElementById('clickCount').value),
        click_interval: parseFloat(document.getElementById('clickInterval').value),
        frequency: parseInt(document.getElementById('frequency').value),
        max_attempts: parseInt(document.getElementById('maxAttempts').value),
        countdown_threshold: parseInt(document.getElementById('countdownThreshold').value),
        countdown_selector: document.getElementById('countdownSelector').value || null,
        countdown_type: document.getElementById('countdownType').value || null,
        remark: document.getElementById('taskRemark').value || null
    };
    
    // 验证连续点击设置
    if (taskData.click_mode === 'continuous' && taskData.click_count < 1) {
        showToast('连续点击次数必须大于0', 'warning');
        return;
    }
    
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 创建中...';
    
    fetch('/seckill/api/tasks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('任务创建成功', 'success');
            // 关闭模态框并重置表单
            const modal = bootstrap.Modal.getInstance(document.getElementById('addTaskModal'));
            modal.hide();
            resetForm();
            // 刷新任务列表
            loadTasks();
        } else {
            showToast('任务创建失败: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('创建任务失败:', error);
        showToast('创建任务失败', 'error');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check"></i> 创建任务';
    });
}

function startTask(taskId) {
    const task = tasks.find(t => t.task_id === taskId);
    if (!task) return;
    
    showToast(`正在启动任务: ${task.name}`, 'info');
    
    fetch(`/seckill/api/tasks/${taskId}/start`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`任务启动成功: ${task.name}`, 'success');
            loadTasks();
        } else {
            showToast(`任务启动失败: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('启动任务失败:', error);
        showToast('启动任务失败', 'error');
    });
}

function stopTask(taskId) {
    const task = tasks.find(t => t.task_id === taskId);
    if (!task) return;
    
    showToast(`正在停止任务: ${task.name}`, 'info');
    
    fetch(`/seckill/api/tasks/${taskId}/stop`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`任务停止成功: ${task.name}`, 'success');
            loadTasks();
        } else {
            showToast(`任务停止失败: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('停止任务失败:', error);
        showToast('停止任务失败', 'error');
    });
}

function resetTask(taskId) {
    const task = tasks.find(t => t.task_id === taskId);
    if (!task) return;
    
    if (confirm(`确定要重置任务"${task.name}"吗？这将清空所有执行记录。`)) {
        showToast(`正在重置任务: ${task.name}`, 'info');
        
        fetch(`/seckill/api/tasks/${taskId}/reset`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`任务重置成功: ${task.name}`, 'success');
                loadTasks();
            } else {
                showToast(`任务重置失败: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            console.error('重置任务失败:', error);
            showToast('重置任务失败', 'error');
        });
    }
}

function deleteTask(taskId) {
    const task = tasks.find(t => t.task_id === taskId);
    if (!task) return;
    
    if (confirm(`确定要删除任务"${task.name}"吗？此操作不可恢复。`)) {
        showToast(`正在删除任务: ${task.name}`, 'info');
        
        fetch(`/seckill/api/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`任务删除成功: ${task.name}`, 'success');
                loadTasks();
            } else {
                showToast(`任务删除失败: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            console.error('删除任务失败:', error);
            showToast('删除任务失败', 'error');
        });
    }
}

function viewTask(taskId) {
    const task = tasks.find(t => t.task_id === taskId);
    if (!task) return;
    
    fetch(`/seckill/api/tasks/${taskId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const task = data.data;
            const content = document.getElementById('taskDetailContent');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle text-primary"></i> 基本信息</h6>
                        <p><strong>任务名称:</strong> ${task.name}</p>
                        <p><strong>目标URL:</strong> <a href="${task.url}" target="_blank">${task.url}</a></p>
                        <p><strong>执行时间:</strong> ${formatDateTime(task.execution_time)}</p>
                        <p><strong>时区:</strong> ${task.timezone}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-chart-line text-success"></i> 执行状态</h6>
                        <p><strong>状态:</strong> <span class="badge ${getStatusBadgeClass(task.status)}">${getStatusText(task.status)}</span></p>
                        <p><strong>尝试次数:</strong> ${task.attempts}/${task.max_attempts}</p>
                        <p><strong>成功次数:</strong> ${task.success_count}</p>
                        <p><strong>创建时间:</strong> ${formatDateTime(task.created_at)}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6><i class="fas fa-cog text-warning"></i> 配置信息</h6>
                        <p><strong>目标选择器:</strong> <code>${task.target_selector}</code> (${task.target_type})</p>
                        <p><strong>执行频率:</strong> ${task.frequency} 秒</p>
                        ${task.countdown_selector ? `<p><strong>倒计时选择器:</strong> <code>${task.countdown_selector}</code> (${task.countdown_type})</p>` : ''}
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
            modal.show();
        } else {
            showToast('获取任务详情失败: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('获取任务详情失败:', error);
        showToast('获取任务详情失败', 'error');
    });
}

// 工具函数
function getStatusBadgeClass(status) {
    switch (status) {
        case 'running': return 'bg-success';
        case 'stopped': return 'bg-danger';
        case 'pending': return 'bg-warning';
        case 'completed': return 'bg-info';
        default: return 'bg-secondary';
    }
}

function getStatusIcon(status) {
    switch (status) {
        case 'running': return 'fa-play-circle';
        case 'stopped': return 'fa-stop-circle';
        case 'pending': return 'fa-clock';
        case 'completed': return 'fa-check-circle';
        default: return 'fa-question-circle';
    }
}

function getStatusText(status) {
    switch (status) {
        case 'running': return '运行中';
        case 'stopped': return '已停止';
        case 'pending': return '等待中';
        case 'completed': return '已完成';
        default: return '未知';
    }
}

function getProgressBarClass(task) {
    const attempts = task.attempts || 0;
    const maxAttempts = task.max_attempts || 0;
    const percentage = maxAttempts > 0 ? (attempts / maxAttempts) * 100 : 0;
    
    if (percentage >= 100) return 'bg-info';
    if (percentage >= 50) return 'bg-warning';
    return 'bg-primary';
}

function getProgressPercentage(task) {
    const attempts = task.attempts || 0;
    const maxAttempts = task.max_attempts || 0;
    return maxAttempts > 0 ? Math.min((attempts / maxAttempts) * 100, 100) : 0;
}

function getSuccessRateClass(task) {
    const successCount = task.success_count || 0;
    const attempts = task.attempts || 0;
    
    if (attempts === 0) return 'text-muted';
    if (successCount === attempts) return 'text-success';
    if (successCount > 0) return 'text-warning';
    return 'text-danger';
}

function getSuccessRateText(task) {
    const successCount = task.success_count || 0;
    const attempts = task.attempts || 0;
    
    if (attempts === 0) return '0%';
    return Math.round((successCount / attempts) * 100) + '%';
}

function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '--';
    const date = new Date(dateTimeStr);
    return date.toLocaleString('zh-CN');
}

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const toastIcon = document.getElementById('toastIcon');
    const toastTitle = document.getElementById('toastTitle');
    const toastMessage = document.getElementById('toastMessage');
    
    // 设置图标和标题
    switch (type) {
        case 'success':
            toastIcon.className = 'fas fa-check-circle me-2 text-success';
            toastTitle.textContent = '成功';
            break;
        case 'error':
            toastIcon.className = 'fas fa-exclamation-circle me-2 text-danger';
            toastTitle.textContent = '错误';
            break;
        case 'warning':
            toastIcon.className = 'fas fa-exclamation-triangle me-2 text-warning';
            toastTitle.textContent = '警告';
            break;
        default:
            toastIcon.className = 'fas fa-info-circle me-2 text-info';
            toastTitle.textContent = '信息';
    }
    
    toastMessage.textContent = message;
    
    // 显示toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// 页面卸载时清理定时器
window.addEventListener('beforeunload', function() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
    if (schedulerStatusInterval) {
        clearInterval(schedulerStatusInterval);
    }
});
</script>

<style>
.badge {
    font-size: 0.75em;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.table th {
    font-weight: 600;
    background-color: #f8f9fa;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.modal-lg {
    max-width: 800px;
}

.progress {
    background-color: #e9ecef;
}

.toast-container {
    z-index: 1055;
}

.table tbody tr:hover {
    background-color: rgba(0,0,0,.075);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.alert {
    border-radius: 0.375rem;
}

#emptyState {
    color: #6c757d;
}

#emptyState i {
    opacity: 0.5;
}
</style>
{% endblock %} 